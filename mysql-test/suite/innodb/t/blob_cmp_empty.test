--source include/have_innodb.inc
--source include/count_sessions.inc

--let fill_amount=`select (@@innodb_page_size/2)+1`

--connect(prevent_purge,localhost,root,,)
start transaction with consistent snapshot;

--connection default
CREATE TABLE t1 (col_text TEXT NOT NULL, KEY (col_text(9))) ENGINE=InnoDB;
--eval INSERT INTO t1 (col_text) VALUES (REPEAT('x', $fill_amount))

UPDATE t1 SET col_text='';
--eval UPDATE t1 SET col_text=REPEAT('y', $fill_amount)

--connect(con1,localhost,root,,)
BEGIN;
--eval INSERT INTO t1 (col_text) VALUES (REPEAT('z', $fill_amount))

--connection default
# If the bug is not fixed, CHECK TABLE will complain about wrong secondary index
# rows count
CHECK TABLE t1;
--disconnect con1
--disconnect prevent_purge
DROP TABLE t1;
--source include/wait_until_count_sessions.inc
